name: Build Windows Release

on:
  push:
    tags:
      - 'v*' # 例如 v1.0.0
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest

    steps:
      # 1. 拉取代码
      - name: Checkout code
        uses: actions/checkout@v3

      # 2. 安装 Flutter
      - name: Install Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          flutter-version: "3.35.1"
          architecture: x64

      # 3. 启用 Windows Desktop 支持
      - name: Enable Windows Desktop
        run: flutter config --enable-windows-desktop

      # 4. 获取依赖
      - name: Get dependencies
        run: flutter pub get

      # 5. 构建 Windows Release
      - name: Build Windows Release
        run: flutter build windows --release

      # 6. 查找 exe 文件
      - name: Find Windows build output
        id: find_exe
        run: |
          $exe = Get-ChildItem -Path build/windows/ -Recurse -Filter *.exe | Select-Object -First 1
          echo "exe_path=$($exe.FullName)" >> $env:GITHUB_OUTPUT

      # 7. 压缩 exe 所在目录
      - name: Create ZIP of Release
        id: zip_release
        run: |
          $exeFile = "${{ steps.find_exe.outputs.exe_path }}"
          $exeDir = Split-Path $exeFile
          $tag = "${{ github.ref_name }}"
          $zipPath = "build/windows/${tag}.zip"
          Compress-Archive -Path "$exeDir\*" -DestinationPath $zipPath
          echo "zip_path=$zipPath" >> $env:GITHUB_OUTPUT

      # 8. 上传到 GitHub Release
      - name: Upload to GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: Release ${{ github.ref_name }}
          files: ${{ steps.zip_release.outputs.zip_path }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
